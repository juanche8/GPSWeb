(function(a){a.widget("ui.multiselect",{_init:function(){this.element.hide();this.id=this.element.attr("id");this.container=a('<div class="ui-multiselect ui-helper-clearfix ui-widget"></div>').insertAfter(this.element);this.count=0;this.selectedContainer=a('<div class="selected"></div>').appendTo(this.container);this.availableContainer=a('<div class="available"></div>').appendTo(this.container);this.selectedActions=a('<div class="actions ui-widget-header ui-helper-clearfix"><span class="count">0 '+a.ui.multiselect.locale.itemsCount+'</span><a href="#" class="remove-all">'+a.ui.multiselect.locale.removeAll+"</a></div>").appendTo(this.selectedContainer);this.availableActions=a('<div class="actions ui-widget-header ui-helper-clearfix"><input type="text" class="search empty ui-widget-content ui-corner-all"/><a href="#" class="add-all">'+a.ui.multiselect.locale.addAll+"</a></div>").appendTo(this.availableContainer);this.selectedList=a('<ul class="selected connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return false}).appendTo(this.selectedContainer);this.availableList=a('<ul class="available connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return false}).appendTo(this.availableContainer);var b=this;this.container.width(this.element.width()+1);this.selectedContainer.width(Math.floor(this.element.width()*this.options.dividerLocation));this.availableContainer.width(Math.floor(this.element.width()*(1-this.options.dividerLocation)));this.selectedList.height(Math.max(this.element.height()-this.selectedActions.height(),1));this.availableList.height(Math.max(this.element.height()-this.availableActions.height(),1));if(!this.options.animated){this.options.show="show";this.options.hide="hide"}this._populateLists(this.element.find("option"));this.options.sortable&&a("ul.selected").sortable({placeholder:"ui-state-highlight",axis:"y",update:function(){b.selectedList.find("li").each(function(){a(this).data("optionLink")&&a(this).data("optionLink").remove().appendTo(b.element)})},receive:function(d,c){c.item.data("optionLink").attr("selected",true);b.count+=1;b._updateCount();b.selectedList.children(".ui-draggable").each(function(){a(this).removeClass("ui-draggable");a(this).data("optionLink",c.item.data("optionLink"));a(this).data("idx",c.item.data("idx"));b._applyItemState(a(this),true)});setTimeout(function(){c.item.remove()},1)}});if(this.options.searchable)this._registerSearchEvents(this.availableContainer.find("input.search"));else a(".search").hide();a(".remove-all").click(function(){b._populateLists(b.element.find("option").removeAttr("selected"));return false});a(".add-all").click(function(){b._populateLists(b.element.find("option").attr("selected","selected"));return false})},destroy:function(){this.element.show();this.container.remove();a.widget.prototype.destroy.apply(this,arguments)},_populateLists:function(c){this.selectedList.children(".ui-element").remove();this.availableList.children(".ui-element").remove();this.count=0;var b=this,d=a(c.map(function(c){var a=b._getOptionNode(this).appendTo(this.selected?b.selectedList:b.availableList).show();if(this.selected)b.count+=1;b._applyItemState(a,this.selected);a.data("idx",c);return a[0]}));this._updateCount()},_updateCount:function(){this.selectedContainer.find("span.count").text(this.count+" "+a.ui.multiselect.locale.itemsCount)},_getOptionNode:function(b){b=a(b);var c=a('<li class="ui-state-default ui-element" title="'+b.text()+'"><span class="ui-icon"/>'+b.text()+'<a href="#" class="action"><span class="ui-corner-all ui-icon"/></a></li>').hide();c.data("optionLink",b);return c},_cloneWithData:function(a){var b=a.clone();b.data("optionLink",a.data("optionLink"));b.data("idx",a.data("idx"));return b},_setSelected:function(c,j){c.data("optionLink").attr("selected",j);if(j){var h=this._cloneWithData(c);c[this.options.hide](this.options.animated,function(){a(this).remove()});h.appendTo(this.selectedList).hide()[this.options.show](this.options.animated);this._applyItemState(h,true);return h}else{var e=this.availableList.find("li"),i=this.options.nodeComparator,g=null,b=c.data("idx"),f=i(c,a(e[b]));if(f)while(b>=0&&b<e.length){f>0?b++:b--;if(f!=i(c,a(e[b]))){g=e[f>0?b:b+1];break}}else g=e[b];var d=this._cloneWithData(c);g?d.insertBefore(a(g)):d.appendTo(this.availableList);c[this.options.hide](this.options.animated,function(){a(this).remove()});d.hide()[this.options.show](this.options.animated);this._applyItemState(d,false);return d}},_applyItemState:function(a,b){if(b){if(this.options.sortable)a.children("span").addClass("ui-icon-arrowthick-2-n-s").removeClass("ui-helper-hidden").addClass("ui-icon");else a.children("span").removeClass("ui-icon-arrowthick-2-n-s").addClass("ui-helper-hidden").removeClass("ui-icon");a.find("a.action span").addClass("ui-icon-minus").removeClass("ui-icon-plus");this._registerRemoveEvents(a.find("a.action"))}else{a.children("span").removeClass("ui-icon-arrowthick-2-n-s").addClass("ui-helper-hidden").removeClass("ui-icon");a.find("a.action span").addClass("ui-icon-plus").removeClass("ui-icon-minus");this._registerAddEvents(a.find("a.action"))}this._registerHoverEvents(a)},_filter:function(g){var f=a(this),b=g.children("li"),e=b.map(function(){return a(this).text().toLowerCase()}),d=a.trim(f.val().toLowerCase()),c=[];if(!d)b.show();else{b.hide();e.each(function(a){this.indexOf(d)>-1&&c.push(a)});a.each(c,function(){a(b[this]).show()})}},_registerHoverEvents:function(b){b.removeClass("ui-state-hover");b.mouseover(function(){a(this).addClass("ui-state-hover")});b.mouseout(function(){a(this).removeClass("ui-state-hover")})},_registerAddEvents:function(c){var b=this;c.click(function(){var c=b._setSelected(a(this).parent(),true);b.count+=1;b._updateCount();return false}).each(function(){a(this).parent().draggable({connectToSortable:"ul.selected",helper:function(){var c=b._cloneWithData(a(this)).width(a(this).width()-50);c.width(a(this).width());return c},appendTo:".ui-multiselect",containment:".ui-multiselect",revert:"invalid"})})},_registerRemoveEvents:function(c){var b=this;c.click(function(){b._setSelected(a(this).parent(),false);b.count-=1;b._updateCount();return false})},_registerSearchEvents:function(c){var b=this;c.focus(function(){a(this).addClass("ui-state-active")}).blur(function(){a(this).removeClass("ui-state-active")}).keypress(function(a){if(a.keyCode==13)return false}).keyup(function(){b._filter.apply(this,[b.availableList])})}});a.extend(a.ui.multiselect,{defaults:{sortable:true,searchable:true,animated:"fast",show:"slideDown",hide:"slideUp",dividerLocation:.6,nodeComparator:function(c,d){var a=c.text(),b=d.text();return a==b?0:a<b?-1:1}},locale:{addAll:"Add all",removeAll:"Remove all",itemsCount:"items selected"}})})(jQuery);